/*** Licensed under the KARMA v.1 Law of Sharing. As others have shared freely to you, so shall you share freely back to us.* If you shall try to cheat and find a loophole in this license, then KARMA will exact your share,* and your worldly gain shall come to naught and those who share shall gain eventually above you.* In compliance with previous GPLv2.0 works of Jorg Janke, Low Heng Sin, Carlos Ruiz and contributors.* This Module Creator is an idea put together and coded by Redhuan D. Oon (red1@red1.org)*/package org.wms.process;
import java.math.BigDecimal;import java.sql.Timestamp;import java.util.List;import org.adempiere.exceptions.AdempiereException;import org.compiere.model.MBPartner;import org.compiere.model.MDocType;import org.compiere.model.MInOut;import org.compiere.model.MInvoice;import org.compiere.model.MInvoiceLine;import org.compiere.model.MOrder;import org.compiere.model.MOrderLine;import org.compiere.model.MPriceList;import org.compiere.model.MPriceListVersion;import org.compiere.model.MProductPrice;import org.compiere.model.MTable;import org.compiere.model.Query;import org.compiere.process.DocAction;import org.compiere.process.ProcessInfoParameter;
import org.compiere.process.SvrProcess;import org.compiere.util.Env;import org.my.model.MWM_Migration;import org.wms.model.MWM_DeliverySchedule;import org.wms.model.MWM_DeliveryScheduleLine;import org.wms.model.MWM_EmptyStorage;import org.wms.model.MWM_EmptyStorageLine;import org.wms.model.MWM_Gate;import org.wms.model.MWM_HandlingUnit;import org.wms.model.MWM_InOut;import org.wms.model.MWM_InOutLine;
/** * Warehouse Migration Process - directly from Excel sheet with just Product, Qty, Price, Locator * Auto create phantom standard PO, Receipts, Putaway to WMS Empty Storage * @author red1 */
	public class MigrateProcess extends SvrProcess {
	private int M_PriceList_Version_ID = 0;
	private int M_Warehouse_ID = 0;
	private int M_Locator_ID = 0; 	private int M_Product_ID = 0;		private int WM_Gate_ID = 0;	private int WM_HandlingUnit_ID=0;
	protected void prepare() {
		ProcessInfoParameter[] para = getParameter();
			for (ProcessInfoParameter p:para) {
				String name = p.getParameterName();
				if (p.getParameter() == null)					;
				else if(name.equals("M_PriceList_Version_ID")){
					M_PriceList_Version_ID = p.getParameterAsInt();
			}
				else if(name.equals("M_Warehouse_ID")){
					M_Warehouse_ID = p.getParameterAsInt();
			}
				else if(name.equals("M_Locator_ID")){
					M_Locator_ID = p.getParameterAsInt();
			}
				else if(name.equals("M_Product_ID")){
					M_Product_ID = p.getParameterAsInt();
			}
		}
	}
	protected String doIt() {		List<MWM_Migration> migration = new Query(getCtx(),MWM_Migration.Table_Name,"",get_TrxName())				.setOnlyActiveRecords(true)				.list();		if (migration==null)			return "NULL";		//check parameters		if (M_PriceList_Version_ID<1)			throw new AdempiereException("PriceList Version not set!");		MPriceListVersion pricelistversion = new MPriceListVersion(getCtx(), M_PriceList_Version_ID, null);		MPriceList pricelist = new MPriceList(getCtx(),pricelistversion.getM_PriceList_ID(),null);				//set phantom gate at warehouse		MWM_Gate gate = new Query(getCtx(),MWM_Gate.Table_Name,MWM_Gate.COLUMNNAME_Name+"=?",get_TrxName())				.setParameters("Phantom").first();		if (gate==null)			gate = new MWM_Gate(getCtx(), 0, get_TrxName());		gate.setM_Warehouse_ID(M_Warehouse_ID);		gate.setName("Phantom");		gate.saveEx(get_TrxName());		WM_Gate_ID = gate.get_ID();				//set phantom Handling Unit		MWM_HandlingUnit handlingunit = new Query(getCtx(),MWM_HandlingUnit.Table_Name,MWM_HandlingUnit.COLUMNNAME_Name+"=?",get_TrxName())				.setParameters("Phantom").first();		if (handlingunit==null)			handlingunit = new MWM_HandlingUnit(getCtx(), 0, get_TrxName()); 		handlingunit.setName("Phantom");		handlingunit.saveEx(get_TrxName());		WM_HandlingUnit_ID = handlingunit.get_ID();				//set Standard Business Partner		MBPartner partner = new Query(getCtx(),MBPartner.Table_Name,MBPartner.COLUMNNAME_Name+"=?",null)				.setParameters("Standard")				.first();		if (partner==null)			throw new AdempiereException("No Standard Business Partner - check first");		int BPartnerID = partner.get_ID();				//create one purchase order for all purchaselines		MOrder purchase = new MOrder(getCtx(), 0, get_TrxName());		purchase.setC_BPartner_ID(BPartnerID);		purchase.setM_Warehouse_ID(Env.getContextAsInt(getCtx(), "#M_Warehouse_ID"));		purchase.setM_PriceList_ID(pricelist.get_ID());		purchase.setIsSOTrx(false);		purchase.setAD_Org_ID(Env.getAD_Org_ID(getCtx()));		purchase.setC_DocType_ID(MDocType.getDocType(MDocType.DOCBASETYPE_PurchaseOrder));		purchase.setC_DocTypeTarget_ID();		purchase.saveEx(get_TrxName());		Boolean processStatus = false;		Utils utils = new Utils(get_TrxName());		Timestamp movementdate = purchase.getCreated();				//WMS DS, Putaway and Material Receipt -- assign handling unit as Draft for every locator		//Post accounts and resubmit postings		//continue WMS to EmptyStorage		MWM_DeliverySchedule deliveryschedule = new MWM_DeliverySchedule(getCtx(), 0, get_TrxName());		deliveryschedule.setWM_Gate_ID(WM_Gate_ID);		deliveryschedule.setC_Order_ID(purchase.get_ID());		deliveryschedule.setDatePromised(purchase.getDatePromised());		deliveryschedule.setDateDelivered(purchase.getDatePromised());		deliveryschedule.setName(purchase.getCreated().toString()+":"+deliveryschedule.getWM_Gate().getName());		deliveryschedule.setC_BPartner_ID(purchase.getC_BPartner_ID());		deliveryschedule.saveEx(get_TrxName());				MWM_InOut wminout = new MWM_InOut(getCtx(), 0, get_TrxName());		wminout.setC_BPartner_ID(deliveryschedule.getC_BPartner_ID());		wminout.setIsSOTrx(false);		wminout.setName(deliveryschedule.getName());		wminout.setWM_DeliverySchedule_ID(deliveryschedule.get_ID());		wminout.saveEx(get_TrxName());				//Invoice creation and completion and accts posted		MInvoice invoice = new MInvoice(purchase,MDocType.getDocType(MDocType.DOCBASETYPE_APInvoice),purchase.getDateOrdered());		invoice.saveEx(get_TrxName());				for (MWM_Migration record:migration) {			if (M_Product_ID>0)				if (record.getM_Product_ID()!=M_Product_ID)					continue;			if (M_Locator_ID>0) {				if (record.getM_Locator_ID()!=M_Locator_ID)					continue;			}						if (M_Warehouse_ID>1) {				if (M_Warehouse_ID!=record.getM_Locator().getM_Warehouse_ID())					continue;			} 			//start Purchase OrderLine				MOrderLine purchaseline = new MOrderLine(purchase);			purchaseline.setM_Product_ID(record.getM_Product_ID());			purchaseline.setQty(record.getMovementQty());			if (record.getMovementDate()!=null)				movementdate = record.getMovementDate();			purchaseline.setDatePromised(movementdate);			purchaseline.setDateDelivered(movementdate);						if (record.getPrice().compareTo(Env.ZERO)>0)				purchaseline.setPrice(record.getPrice());			else {				//get from PriceListVersion				MProductPrice productprice = new MProductPrice(getCtx(), M_PriceList_Version_ID, M_Product_ID, null);				purchaseline.setPrice(productprice.getPriceStd());			}			purchaseline.saveEx(get_TrxName());						MWM_DeliveryScheduleLine dline = new MWM_DeliveryScheduleLine(Env.getCtx(), 0, get_TrxName());			dline.setWM_DeliverySchedule_ID(deliveryschedule.get_ID());			dline.setC_OrderLine_ID(purchaseline.getC_OrderLine_ID());			dline.setM_Product_ID(purchaseline.getM_Product_ID());			dline.setM_AttributeSetInstance_ID(purchaseline.getM_AttributeSetInstance_ID());			dline.setC_UOM_ID(purchaseline.getC_UOM_ID());			dline.setReceived(true);			dline.setQtyOrdered(purchaseline.getQtyOrdered());			dline.setQtyDelivered(purchaseline.getQtyOrdered());			dline.saveEx(get_TrxName());						//invoice creation and posting			MInvoiceLine invoiceline = new MInvoiceLine(invoice);			invoiceline.setOrderLine(purchaseline);			invoiceline.setQty(purchaseline.getQtyOrdered());			invoiceline.saveEx(get_TrxName());						//Locator EmptyStorage			MWM_EmptyStorage empty = new Query(getCtx(),MWM_EmptyStorage.Table_Name,MWM_EmptyStorage.COLUMNNAME_M_Locator_ID+"=?",get_TrxName())					.setParameters(record.getM_Locator_ID())					.first();			if (empty==null)				throw new AdempiereException("No EmptyStorage at Locator ID - "+record.getM_Locator_ID());						//create put-away list			MWM_InOutLine inoutline = utils.newInOutLine(wminout, dline, purchaseline.getQtyOrdered());			inoutline.setM_Locator_ID(record.getM_Locator_ID());			inoutline.setWM_HandlingUnit_ID(WM_HandlingUnit_ID);			inoutline.saveEx(get_TrxName());						MWM_EmptyStorageLine sline = utils.newEmptyStorageLine(dline, purchaseline.getQtyOrdered(), empty, inoutline);			sline.setDateStart(purchaseline.getDatePromised());			sline.setWM_HandlingUnit_ID(WM_HandlingUnit_ID);			sline.saveEx(get_TrxName());						//deduct Empty Available Storage -- calculate Percentage			BigDecimal available = empty.getAvailableCapacity().subtract(sline.getQtyMovement());			empty.setAvailableCapacity(available);			utils.calculatePercentageVacant(dline, empty);		}		//Complete Purchase		purchase.setDocStatus(MOrder.DOCSTATUS_InProgress);		purchase.setDocAction(MOrder.DOCACTION_Complete);		processStatus = purchase.processIt(DocAction.ACTION_Complete);		purchase.saveEx(get_TrxName()); 		invoice.setDocStatus(invoice.DOCSTATUS_InProgress);		invoice.setDocAction(invoice.DOCACTION_Complete);		processStatus = invoice.processIt(DocAction.ACTION_Complete);		invoice.saveEx(get_TrxName());				wminout.completeIt();		wminout.saveEx(get_TrxName());				return "Invoice Completion "+processStatus.toString(); 
	}
}
